openapi: 3.1.0
info:
  title: CHAD GitHub Control Plane (Phase-4)
  version: "1.0.0"
  description: |
    Private, write-enabled endpoints for the CHAD Phase-4 builder agent.
    Scope: create/update files on a PR branch, update PR body, and read CI status.
servers:
  - url: https://api.github.com
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: Authorization
      description: 'Use a GitHub PAT with scopes: repo, workflow. Format: "token <PAT>" or "Bearer <PAT>"'
  schemas:
    FileCommitRequest:
      type: object
      required: [message, content]
      properties:
        message: { type: string, minLength: 3 }
        content:
          type: string
          description: Base64-encoded file contents (RFC4648)
        sha:
          type: string
          description: Optional blob SHA when updating an existing path
        committer:
          type: object
          properties:
            name: { type: string }
            email: { type: string }
    FileCommitResponse:
      type: object
      properties:
        content:
          type: object
          properties:
            path: { type: string }
            sha:  { type: string }
    PRUpdateRequest:
      type: object
      properties:
        title: { type: string }
        body:  { type: string }

security:
  - ApiKeyAuth: []

paths:
  /repos/{owner}/{repo}/contents/{path}:
    put:
      operationId: putFile
      summary: Create or update a file in a PR branch
      parameters:
        - in: path
          name: owner
          required: true
          schema: { type: string }
        - in: path
          name: repo
          required: true
          schema: { type: string }
        - in: path
          name: path
          required: true
          schema: { type: string }
        - in: query
          name: branch
          required: true
          schema: { type: string, default: "phase4_exec_and_risk_spec" }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FileCommitRequest'
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/FileCommitResponse' }
        "200":
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/FileCommitResponse' }

  /repos/{owner}/{repo}/pulls/{pull_number}:
    patch:
      operationId: updatePr
      summary: Update PR title/body
      parameters:
        - in: path
          name: owner
          required: true
          schema: { type: string }
        - in: path
          name: repo
          required: true
          schema: { type: string }
        - in: path
          name: pull_number
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PRUpdateRequest'
      responses:
        "200":
          description: PR updated

  /repos/{owner}/{repo}/commits/{ref}/status:
    get:
      operationId: getCommitStatus
      summary: Get combined CI status for a commit (use PR head SHA)
      parameters:
        - in: path
          name: owner
          required: true
          schema: { type: string }
        - in: path
          name: repo
          required: true
          schema: { type: string }
        - in: path
          name: ref
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Combined status (success/pending/failure/error)
          content:
            application/json:
              schema:
                type: object
                properties:
                  state: { type: string, enum: [success, pending, failure, error] }
                  statuses:
                    type: array
                    items:
                      type: object
                      properties:
                        context:    { type: string }
                        state:      { type: string }
                        target_url: { type: string }
